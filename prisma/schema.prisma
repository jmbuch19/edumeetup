generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ... existing generator and datasource ...

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   // "STUDENT", "UNIVERSITY", "ADMIN"
  status    String   @default("ACTIVE") // "ACTIVE", "PENDING", "SUSPENDED"
  createdAt DateTime @default(now())

  studentProfile    StudentProfile?
  universityProfile UniversityProfile?
  supportTickets    SupportTicket[]
  notifications     Notification[]
  meetingParticipants MeetingParticipant[]

  sessionToken      String?  @unique // For Single Session enforcement
  auditLogs         AuditLog[]
}


model StudentProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Section A: Basic Profile
  fullName          String
  gender            String?  // "Male", "Female", "Prefer not to say"
  ageGroup          String?  // "Under 20", "21-25", "26-30", "31+"
  country           String?
  currentStatus     String? // "Grade12", "BachelorFinalYear", "BachelorCompleted", "MasterCompleted", "WorkingProfessional"
  
  // Section B: Study Preference
  fieldOfInterest   String? // Enum: Computer Science, Engineering, etc.
  preferredCountries String? // Comma separated
  preferredDegree   String? // "Bachelor's", "Master's", "MBA", "PhD", "Certificate"
  budgetRange       String? // "< 15,000", "15,000â€“25,000", etc.
  englishTestType   String? // "IELTS", "TOEFL", "Duolingo", "PTE", "Not Taken Yet"
  englishScore      String? // Score as string to handle "Not Taken Yet" or ranges, or just use score
  preferredIntake   String? // "Fall", "Spring", "Summer"
  
  profileComplete   Boolean  @default(false)
  updatedAt         DateTime @updatedAt

  interests Interest[]
}

model UniversityProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  institutionName   String
  country           String
  city              String?
  website           String?
  
  // New Fields
  repName           String?
  repDesignation    String?
  repEmail          String?
  contactPhone      String?
  accreditation     String?
  scholarshipsAvailable Boolean @default(false)

  contactEmail      String?   // Existing field, maybe redundant with repEmail but keeping for now
  verificationStatus String   @default("PENDING") // "PENDING", "VERIFIED", "REJECTED"
  verifiedDate      DateTime?
  logo              String?   // URL to image
  meetingLink       String?   // URL to Calendly, Google Meet, etc.

  programs  Program[]
  interests Interest[]
  meetingsCreated Meeting[]
  availabilitySlots AvailabilitySlot[]


}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // e.g., "VERIFY_UNIVERSITY", "DELETE_PROGRAM"
  entityType String  // e.g., "UNIVERSITY", "PROGRAM"
  entityId  String
  actorId   String   // User ID of who performed the action
  actor     User     @relation(fields: [actorId], references: [id])
  metadata  Json?    // Extra details
  createdAt DateTime @default(now())
}


model Program {
  id             String            @id @default(cuid())
  universityId   String
  university     UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  programName    String
  degreeLevel    String            // Storing Enum as String for SQLite/Simple compatibility, or use Enum if DB supports
  fieldCategory  FieldCategory     @default(Others)
  stemDesignated Boolean           @default(false)
  durationMonths Int               @default(12)
  tuitionFee     Float             @default(0)
  currency       String            @default("USD")
  englishTests   String?           // Comma separated list of accepted tests
  minEnglishScore Float?
  intakes        String?           // Comma separated list of intakes (Spring, Fall, etc.)

  // degreeLevel    DegreeLevel     // If using proper Enums
  // fieldCategory  FieldCategory
  
  status         String            @default("ACTIVE") // "ACTIVE", "PAUSED"

  interests Interest[]
}

model Interest {
  id             String            @id @default(cuid())
  studentId      String
  student        StudentProfile    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  universityId   String
  university     UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  programId      String?
  program        Program?          @relation(fields: [programId], references: [id])
  status         String            @default("INTERESTED") // "INTERESTED", "WITHDRAWN", "ARCHIVED", "SHORTLISTED"
  studentMessage String?
  universityNote String?
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([studentId, universityId, programId])
}

model Meeting {
  id                    String            @id @default(cuid())
  createdByUniversityId String
  university            UniversityProfile @relation(fields: [createdByUniversityId], references: [id], onDelete: Cascade)

  meetingType    String // "ONE_TO_ONE", "GROUP"
  title          String
  agenda         String?
  startTime      DateTime
  endTime        DateTime
  timezone       String            @default("UTC")
  locationType   String            @default("VIDEO") // "VIDEO", "IN_PERSON"
  joinUrl        String?

  status         String            @default("SCHEDULED") // "DRAFT", "SCHEDULED", "COMPLETED", "CANCELED"
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  participants   MeetingParticipant[]
  availabilitySlot AvailabilitySlot?
}

model MeetingParticipant {
  id             String            @id @default(cuid())
  meetingId      String
  meeting        Meeting           @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Linking to User allows both Student and UniversityRep (if needed as participant)
  // But typically UniversityRep is the host (via createdByUniversityId)
  // We'll stick to a generic participantUserId for flexibility
  participantUserId String
  user           User              @relation(fields: [participantUserId], references: [id], onDelete: Cascade)

  participantType String           @default("STUDENT") // "STUDENT", "UNIVERSITY_REP"
  rsvpStatus     String            @default("INVITED") // "INVITED", "ACCEPTED", "DECLINED", "NO_RESPONSE"
  role           String            @default("ATTENDEE") // "HOST", "ATTENDEE"

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([meetingId, participantUserId])
}

model Notification {
  id             String            @id @default(cuid())
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type           String            // "MEETING_INVITE", "MEETING_UPDATE", "MEETING_CANCELED"
  title          String
  message        String
  payload        Json?             // Flexible data (e.g. meetingId)
  isRead         Boolean           @default(false)
  
  createdAt      DateTime          @default(now())
}

model AvailabilitySlot {
  id             String            @id @default(cuid())
  universityId   String
  university     UniversityProfile @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  startTime      DateTime
  endTime        DateTime
  isBooked       Boolean           @default(false)
  
  meetingId      String?           @unique
  meeting        Meeting?          @relation(fields: [meetingId], references: [id])

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([universityId])
  @@index([startTime])
}


enum FieldCategory {
  Computer_Science  @map("Computer Science")
  Engineering
  Business
  Data_Science      @map("Data Science")
  Health_Sciences   @map("Health Sciences")
  Social_Sciences   @map("Social Sciences")
  Arts_Humanities   @map("Arts & Humanities")
  Law
  Architecture
  Others
}

// Enums (handled as strings in SQLite usually, but good for validation)
// DegreeLevel: Associate, Bachelor's, Master's, MBA, PhD, Certificate
// FieldCategory: Computer Science, Engineering, Business, Data Science, Health Sciences, Social Sciences, Arts & Humanities, Law, Architecture, Others
// Intake: Fall, Spring, Summer
// EnglishTest: IELTS, TOEFL, Duolingo, PTE, Not Required

enum InquiryStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum TicketType {
  STUDENT
  UNIVERSITY
}

model PublicInquiry {
  id        String   @id @default(cuid())
  fullName  String
  email     String
  role      String   // Student, University, etc.
  country   String
  subject   String
  message   String
  phone     String?
  orgName   String?
  status    InquiryStatus @default(NEW)
  createdAt DateTime @default(now())
}

model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      TicketType
  category  String
  priority  TicketPriority
  message   String
  status    InquiryStatus @default(NEW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
