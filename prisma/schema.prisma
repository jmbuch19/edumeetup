generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                @id @default(cuid())
  name                  String?
  email                 String                @unique
  emailVerified         DateTime?
  password              String?
  image                 String?
  role                  UserRole              @default(STUDENT)
  isActive              Boolean               @default(true)
  consentMarketing      Boolean               @default(true)
  consentAnalytics      Boolean               @default(true)
  consentWithdrawnAt    DateTime?
  deletionRequestedAt   DateTime?
  deletionScheduledFor  DateTime?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  universityId          String?
  accounts              Account[]
  announcements         AdminAnnouncement[]   @relation("AnnouncementAuthor")
  advisedRequests       AdvisoryRequest[]     @relation("AdviserRequests")
  auditLogs             AuditLog[]
  availabilityProfiles  AvailabilityProfile[] @relation("RepAvailability")
  availabilitySlots     AvailabilitySlot[]
  consentHistory        ConsentHistory[]
  meetings              Meeting[]             @relation("RepMeetings")
  meetingNotifications  MeetingNotification[]
  meetingParticipations MeetingParticipant[]
  notifications         Notification[]
  sessions              Session[]
  student               Student?
  supportTickets        SupportTicket[]
  systemReports         SystemReport[]
  university            University?
  representedUniversity University?           @relation("UniversityReps", fields: [universityId], references: [id])

  @@index([role])
  @@index([isActive])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Student {
  id                 String                @id @default(cuid())
  userId             String                @unique
  phone              String?
  whatsappNumber     String?
  city               String?
  pincode            String?
  country            String?               @default("India")
  ipAddress          String?
  ipCity             String?
  ipRegion           String?
  ipCountry          String?
  ipPincode          String?
  ipLatitude         String?
  ipLongitude        String?
  ipIsp              String?
  cityMismatch       Boolean               @default(false)
  pincodeMismatch    Boolean               @default(false)
  fullName           String?
  gender             String?
  ageGroup           String?
  currentStatus      String?
  fieldOfInterest    String?
  preferredCountries String?
  preferredDegree    String?
  budgetRange        String?
  englishTestType    String?
  englishScore       String?
  greScore           String?
  gmatScore          String?
  preferredIntake    String?
  profileComplete    Boolean               @default(false)
  profileVersion     Int                   @default(1)
  cvUrl              String?
  cvFileName         String?
  cvUploadedAt       DateTime?
  cvSizeBytes        Int?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  advisoryRequests   AdvisoryRequest[]
  bookmarks          Bookmark[]
  eventRegistrations EventRegistration[]
  interests          Interest[]
  meetings           Meeting[]
  changeLogs         ProfileChangeLog[]
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications      StudentNotification[]
}

model ProfileChangeLog {
  id            String   @id @default(cuid())
  studentId     String
  version       Int
  changedFields Json
  snapshot      Json
  changedAt     DateTime @default(now())
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}

model University {
  id                      String                   @id @default(cuid())
  userId                  String                   @unique
  institutionName         String
  country                 String
  city                    String?
  website                 String?
  accreditationNo         String?
  verificationStatus      String                   @default("PENDING")
  verifiedAt              DateTime?
  verifiedByAdmin         String?
  verificationDocUrl      String?
  docUploadDate           DateTime?                @default(now())
  contactEmail            String?
  logo                    String?
  brandColor              String?                  @default("#2563eb")
  about                   String?
  foundedYear             Int?
  campusSize              String?
  totalStudents           Int?
  internationalStudents   Int?
  repName                 String?
  repDesignation          String?
  repEmail                String?
  contactPhone            String?
  scholarshipsAvailable   Boolean                  @default(false)
  meetingLink             String?
  certAuthority           Boolean                  @default(false)
  certLegitimacy          Boolean                  @default(false)
  certPurpose             Boolean                  @default(false)
  certAccountability      Boolean                  @default(false)
  certTimestamp           DateTime?
  certIp                  String?
  approvalMode            String                   @default("MANUAL")
  defaultDuration         Int                      @default(15)
  dailyCapPerRep          Int                      @default(10)
  minLeadTimeHours        Int                      @default(24)
  bufferMinutes           Int                      @default(10)
  cancellationWindowHours Int                      @default(24)
  isPublic                Boolean                  @default(true)
  notifQuota              Int                      @default(3)    // weekly campaigns admin can set
  notifPaused             Boolean                  @default(false) // admin kill switch
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  universityNameFromEmail String?
  countryFromEmail        String?
  availabilityProfiles    AvailabilityProfile[]
  availabilitySlots       AvailabilitySlot[]
  bookmarkedBy            Bookmark[]
  events                  Event[]
  hostOutreach            HostRequestOutreach[]
  interests               Interest[]
  meetings                Meeting[]
  programs                Program[]
  sponsoredContent        SponsoredContent[]
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents               UniversityDocument[]
  notifications           UniversityNotification[]
  reps                    User[]                   @relation("UniversityReps")

  @@index([verificationStatus])
  @@index([country])
}

model UniversityDocument {
  id           String     @id @default(cuid())
  universityId String
  displayName  String
  category     String
  fileName     String
  fileUrl      String
  mimeType     String     @default("application/pdf")
  sizeBytes    Int
  uploadedAt   DateTime   @default(now())
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([universityId])
}

model Program {
  id              String     @id @default(cuid())
  universityId    String
  programName     String
  degreeLevel     String
  fieldCategory   String
  durationMonths  Int?
  tuitionFee      Float?
  currency        String?    @default("USD")
  status          String     @default("ACTIVE")
  stemDesignated  Boolean    @default(false)
  englishTests    String[]
  minEnglishScore Float?
  intakes         String[]
  description     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  interests       Interest[]
  meetings        Meeting[]
  university      University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model Interest {
  id             String     @id @default(cuid())
  studentId      String
  universityId   String
  programId      String?
  status         String     @default("INTERESTED")
  studentMessage String?
  universityNote String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  program        Program?   @relation(fields: [programId], references: [id], onDelete: Cascade)
  student        Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  university     University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@unique([studentId, universityId, programId])
  @@index([status])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  payload   Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  actorId    String?
  metadata   Json?
  createdAt  DateTime @default(now())
  actor      User?    @relation(fields: [actorId], references: [id])
}

model AdvisoryRequest {
  id              String         @id @default(cuid())
  studentId       String
  targetDegree    String?
  fieldOfInterest String?
  targetCountry   String?
  budgetRange     String?
  englishScore    String?
  greGmatScore    String?
  preferredTime   String?
  targetIntake    String?
  openQuestion    String?
  status          AdvisoryStatus @default(NEW)
  adviserId       String?
  internalNotes   String?
  sessionLink     String?
  createdAt       DateTime       @default(now())
  completedAt     DateTime?
  adviser         User?          @relation("AdviserRequests", fields: [adviserId], references: [id])
  student         Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([studentId])
}

model PublicInquiry {
  id        String        @id @default(cuid())
  fullName  String
  email     String
  role      String
  country   String
  subject   String
  message   String
  phone     String?
  orgName   String?
  status    InquiryStatus @default(NEW)
  createdAt DateTime      @default(now())
}

model SupportTicket {
  id        String         @id @default(cuid())
  userId    String
  type      TicketType
  category  String
  priority  TicketPriority
  message   String
  status    InquiryStatus  @default(NEW)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HostRequest {
  id                     String                @id @default(cuid())
  referenceNumber        String                @unique
  institutionName        String
  institutionType        String
  city                   String
  state                  String
  websiteUrl             String
  contactName            String
  contactDesignation     String
  contactEmail           String
  contactPhone           String
  preferredDateStart     DateTime
  preferredDateEnd       DateTime
  expectedStudentCount   String
  preferredCountries     Json
  fieldsOfStudy          Json
  additionalRequirements String?
  status                 String                @default("SUBMITTED")
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  outreach               HostRequestOutreach[]
}

model HostRequestOutreach {
  id            String      @id @default(cuid())
  hostRequestId String
  universityId  String
  status        String      @default("SENT")
  sentAt        DateTime    @default(now())
  respondedAt   DateTime?
  responseNote  String?
  hostRequest   HostRequest @relation(fields: [hostRequestId], references: [id], onDelete: Cascade)
  university    University  @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@unique([hostRequestId, universityId])
  @@index([hostRequestId])
  @@index([universityId])
}

model AvailabilityProfile {
  id                     String        @id @default(cuid())
  universityId           String
  repId                  String
  dayOfWeek              DayOfWeek
  startTime              String
  endTime                String
  isActive               Boolean       @default(true)
  meetingDurationOptions Int[]
  bufferMinutes          Int           @default(10)
  minLeadTimeHours       Int           @default(12)
  dailyCap               Int           @default(8)
  videoProvider          VideoProvider @default(GOOGLE_MEET)
  externalLink           String?
  eligibleDegreeLevels   String[]
  eligibleCountries      String[]
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  repUser                User          @relation("RepAvailability", fields: [repId], references: [id], onDelete: Cascade)
  university             University    @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([universityId])
  @@index([repId])
}

model Meeting {
  id                     String                @id @default(cuid())
  studentId              String?
  universityId           String
  repId                  String?
  programId              String?
  title                  String?
  agenda                 String?
  meetingType            String?
  joinUrl                String?
  purpose                MeetingPurpose
  studentQuestions       String?
  uploadedDocUrl         String?
  durationMinutes        Int
  startTime              DateTime
  endTime                DateTime
  studentTimezone        String
  repTimezone            String
  status                 MeetingStatus         @default(PENDING)
  videoProvider          VideoProvider
  videoLink              String?
  meetingCode            String
  cancellationReason     String?
  cancelledBy            String?
  cancelledAt            DateTime?
  isLateCancel           Boolean               @default(false)
  rescheduleProposedBy   String?
  rescheduleProposedTime DateTime?
  universityNotes        String?
  studentNotes           String?
  studentRating          Int?
  universityRating       Int?
  reminder24hSent        Boolean               @default(false)
  reminder1hSent         Boolean               @default(false)
  reminder10minSent      Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  availabilitySlot       AvailabilitySlot?
  program                Program?              @relation(fields: [programId], references: [id])
  rep                    User?                 @relation("RepMeetings", fields: [repId], references: [id], onDelete: Cascade)
  student                Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  university             University            @relation(fields: [universityId], references: [id], onDelete: Cascade)
  notifications          MeetingNotification[]
  participants           MeetingParticipant[]

  @@index([studentId])
  @@index([universityId])
  @@index([repId])
  @@index([status])
}

model MeetingParticipant {
  id                String    @id @default(cuid())
  meetingId         String
  participantUserId String
  participantType   String    @default("STUDENT")
  rsvpStatus        String    @default("INVITED")
  joinedAt          DateTime?
  meeting           Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [participantUserId], references: [id], onDelete: Cascade)

  @@unique([meetingId, participantUserId])
  @@index([participantUserId])
  @@index([meetingId])
}

model MeetingNotification {
  id             String   @id @default(cuid())
  meetingId      String
  recipientId    String
  type           String
  channel        String
  sentAt         DateTime @default(now())
  delivered      Boolean  @default(false)
  contentPreview String?
  meeting        Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  recipient      User     @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([recipientId])
}

model AvailabilitySlot {
  id           String     @id @default(cuid())
  universityId String
  repId        String
  startTime    DateTime
  endTime      DateTime
  isBooked     Boolean    @default(false)
  meetingId    String?    @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  meeting      Meeting?   @relation(fields: [meetingId], references: [id])
  repUser      User       @relation(fields: [repId], references: [id], onDelete: Cascade)
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([universityId])
  @@index([repId])
}

model Bookmark {
  id           String     @id @default(cuid())
  studentId    String
  universityId String
  note         String?
  createdAt    DateTime   @default(now())
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@unique([studentId, universityId])
}

model Event {
  id            String              @id @default(cuid())
  universityId  String
  title         String
  description   String
  dateTime      DateTime
  location      String
  type          String
  capacity      Int?
  isPublished   Boolean             @default(false)
  status        String              @default("UPCOMING")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  university    University          @relation(fields: [universityId], references: [id], onDelete: Cascade)
  registrations EventRegistration[]
}

model EventRegistration {
  id        String   @id @default(cuid())
  eventId   String
  studentId String
  status    String   @default("REGISTERED")
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([eventId, studentId])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  type      String
  message   String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([type])
  @@index([level])
}

model SystemReport {
  id            String   @id @default(cuid())
  type          String
  message       String
  userId        String?
  path          String?
  screenshotUrl String?
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id])
}

model BotMisses {
  id        String   @id @default(cuid())
  question  String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model StudentNotification {
  id        String   @id @default(cuid())
  studentId String
  title     String
  message   String
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}

model UniversityNotification {
  id           String     @id @default(cuid())
  universityId String
  title        String
  message      String
  type         String     @default("INFO")
  isRead       Boolean    @default(false)
  actionUrl    String?
  createdAt    DateTime   @default(now())
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([universityId])
}

model AdminAnnouncement {
  id               String    @id @default(cuid())
  title            String
  content          String
  targetAudience   String    @default("ALL")
  isActive         Boolean   @default(true)
  priority         String    @default("NORMAL")
  announcementType String    @default("GENERAL")
  filters          Json?
  emailSent        Boolean   @default(false)
  sentById         String?
  startsAt         DateTime  @default(now())
  expiresAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sentBy           User?     @relation("AnnouncementAuthor", fields: [sentById], references: [id])

  @@index([sentById])
}

model SponsoredContent {
  id             String      @id @default(cuid())
  title          String
  partnerName    String
  universityId   String?
  imageUrl       String
  targetUrl      String
  sponsorType    String      @default("UNIVERSITY")
  mobileImageUrl String?
  priority       Int         @default(5)
  startDate      DateTime    @default(now())
  endDate        DateTime?
  status         String      @default("DRAFT")
  placement      String
  isActive       Boolean     @default(true)
  impressions    Int         @default(0)
  clicks         Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  university     University? @relation(fields: [universityId], references: [id])

  @@index([universityId])
  @@index([isActive])
  @@index([status])
  @@index([startDate])
}

model ConsentHistory {
  id        String   @id @default(cuid())
  userId    String
  field     String
  oldValue  Boolean
  newValue  Boolean
  changedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([changedAt])
}

enum UserRole {
  STUDENT
  UNIVERSITY
  UNIVERSITY_REP
  ADMIN
}

enum FieldCategory {
  Computer_Science @map("Computer Science")
  Engineering
  Business
  Data_Science     @map("Data Science")
  Health_Sciences  @map("Health Sciences")
  Social_Sciences  @map("Social Sciences")
  Arts_Humanities  @map("Arts & Humanities")
  Law
  Architecture
  Others
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum TicketType {
  STUDENT
  UNIVERSITY
}

enum AdvisoryStatus {
  NEW
  ASSIGNED
  SCHEDULED
  COMPLETED
  FOLLOW_UP
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum VideoProvider {
  GOOGLE_MEET
  ZOOM
  EXTERNAL_LINK
}

enum MeetingStatus {
  DRAFT
  PENDING
  CONFIRMED
  RESCHEDULE_PROPOSED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum MeetingPurpose {
  ADMISSION_QUERY
  PROGRAM_FIT
  SCHOLARSHIP_INFO
  DOCUMENT_HELP
  APPLICATION_STATUS
  OTHER
}
