generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth Models (Standard Auth.js / NextAuth)

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(STUDENT)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  
  // Relations to Profiles
  student       Student?
  university    University?
  
  // Relations to Features
  supportTickets    SupportTicket[]
  notifications     Notification[]
  meetingParticipants MeetingParticipant[]
  auditLogs         AuditLog[]
  advisedRequests   AdvisoryRequest[] @relation("AdviserRequests")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Domain Models

model Student {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Contact & Location
  phone             String?
  city              String?
  pincode           String?
  country           String?  @default("India")
  
  // IP Tracking & Verification
  ipAddress         String?
  ipCity            String?
  ipRegion          String?
  ipCountry         String?
  ipPincode         String?
  ipLatitude        String?
  ipLongitude       String?
  ipIsp             String?
  
  cityMismatch      Boolean  @default(false)
  pincodeMismatch   Boolean  @default(false)

  // Preserved Profile Fields (Critical for App Functionality)
  fullName          String? // Can sync with User.name
  gender            String?
  ageGroup          String?
  currentStatus     String?
  fieldOfInterest   String?
  preferredCountries String?
  preferredDegree   String?
  budgetRange       String?
  englishTestType   String?
  englishScore      String?
  preferredIntake   String?
  profileComplete   Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  interests         Interest[]
  advisoryRequests  AdvisoryRequest[]
}

model University {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  institutionName   String      // Renamed from universityName to match code usage
  country           String
  city              String?
  website           String?
  accreditationNo   String?
  
  verificationStatus String   @default("PENDING") // Added to match code usage
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  verifiedByAdmin   String?
  
  // Preserved Fields
  contactEmail      String?
  logo              String?
  about             String?   @db.Text
  foundedYear       Int?
  campusSize        String?
  totalStudents     Int?
  internationalStudents Int?
  
  // Rep Details (Merged from old schema)
  repName           String?
  repDesignation    String?
  repEmail          String?
  contactPhone      String?
  
  // Features
  scholarshipsAvailable Boolean @default(false)
  meetingLink       String?
  
  // Certification
  certAuthority     Boolean   @default(false)
  certLegitimacy    Boolean   @default(false)
  certPurpose       Boolean   @default(false)
  certAccountability Boolean  @default(false)
  certTimestamp     DateTime?
  certIp            String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  programs          Program[]
  interests         Interest[]
  meetingsCreated   Meeting[]
  availabilitySlots AvailabilitySlot[]
}

model Program {
  id             String      @id @default(cuid())
  universityId   String
  university     University  @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  programName    String
  degreeLevel    String
  fieldCategory  String
  durationMonths Int?        // Renamed from duration to match code if needed, but let's check code usage.
  tuitionFee     Float?
  currency       String?     @default("USD")
  
  // Preserved fields
  status         String      @default("ACTIVE")
  stemDesignated Boolean     @default(false)
  englishTests   String?
  minEnglishScore Float?
  intakes        String?
  description    String?     @db.Text
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  interests      Interest[]
}

// Enums

enum UserRole {
  STUDENT
  UNIVERSITY
  ADMIN
}

// Feature Models (Updated to use new Student/University relations)

model Interest {
  id             String      @id @default(cuid())
  studentId      String
  student        Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  universityId   String
  university     University  @relation(fields: [universityId], references: [id], onDelete: Cascade)
  programId      String?
  program        Program?    @relation(fields: [programId], references: [id], onDelete: Cascade)
  status         String      @default("INTERESTED")
  studentMessage String?
  universityNote String?
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([studentId, universityId, programId])
}

model Meeting {
  id                    String      @id @default(cuid())
  createdByUniversityId String
  university            University  @relation(fields: [createdByUniversityId], references: [id], onDelete: Cascade)

  meetingType    String
  title          String
  agenda         String?
  startTime      DateTime
  endTime        DateTime
  timezone       String      @default("UTC")
  locationType   String      @default("VIDEO")
  joinUrl        String?

  status         String      @default("SCHEDULED")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  participants   MeetingParticipant[]
  availabilitySlot AvailabilitySlot?
}

model MeetingParticipant {
  id             String      @id @default(cuid())
  meetingId      String
  meeting        Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  participantUserId String
  user           User        @relation(fields: [participantUserId], references: [id], onDelete: Cascade)

  participantType String     @default("STUDENT")
  rsvpStatus     String      @default("INVITED")
  role           String      @default("ATTENDEE")

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([meetingId, participantUserId])
}

model Notification {
  id             String      @id @default(cuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type           String
  title          String
  message        String
  payload        Json?
  isRead         Boolean     @default(false)
  
  createdAt      DateTime    @default(now())
}

model AvailabilitySlot {
  id             String      @id @default(cuid())
  universityId   String
  university     University  @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  startTime      DateTime
  endTime        DateTime
  isBooked       Boolean     @default(false)
  
  meetingId      String?     @unique
  meeting        Meeting?    @relation(fields: [meetingId], references: [id])

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([universityId])
  @@index([startTime])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entityType String
  entityId  String
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  metadata  Json?
  createdAt DateTime @default(now())
}

model AdvisoryRequest {
  id            String   @id @default(cuid())
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  targetDegree  String?
  fieldOfInterest String?
  targetCountry String?
  budgetRange   String?
  englishScore  String?
  greGmatScore  String?
  preferredTime String?
  targetIntake  String?
  openQuestion  String?  @db.Text

  status        AdvisoryStatus @default(NEW)
  adviserId     String?
  adviser       User?    @relation("AdviserRequests", fields: [adviserId], references: [id], onDelete: SetNull)
  
  internalNotes String?  @db.Text
  sessionLink   String?

  createdAt     DateTime @default(now())
  completedAt   DateTime?
}

// Preserve Enums for Feature Compatibility
enum FieldCategory {
  Computer_Science  @map("Computer Science")
  Engineering
  Business
  Data_Science      @map("Data Science")
  Health_Sciences   @map("Health Sciences")
  Social_Sciences   @map("Social Sciences")
  Arts_Humanities   @map("Arts & Humanities")
  Law
  Architecture
  Others
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum TicketType {
  STUDENT
  UNIVERSITY
}

model PublicInquiry {
  id        String   @id @default(cuid())
  fullName  String
  email     String
  role      String
  country   String
  subject   String
  message   String
  phone     String?
  orgName   String?
  status    InquiryStatus @default(NEW)
  createdAt DateTime @default(now())
}

model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      TicketType
  category  String
  priority  TicketPriority
  message   String
  status    InquiryStatus @default(NEW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AdvisoryStatus {
  NEW
  ASSIGNED
  SCHEDULED
  COMPLETED
  FOLLOW_UP
}
